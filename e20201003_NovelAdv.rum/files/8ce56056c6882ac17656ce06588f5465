using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using DxLibDLL;
using Charlotte.Commons;
using Charlotte.GameCommons;
using Charlotte.Games.Surfaces;

namespace Charlotte.Games
{
	public class Game : IDisposable
	{
		public GameStatus Status = new GameStatus(); // 軽量な仮設オブジェクト
		public bool LoadedFlag = false;

		// <---- prm

		public static Game I;

		/// <summary>
		/// 削除されたサーフェスに残されたアクションを(アクションが終了するまで)保持する。
		/// </summary>
		public DDTaskList SurfaceEL;

		public Game()
		{
			I = this;

			this.SurfaceEL = new DDTaskList();
		}

		public void Dispose()
		{
			this.SurfaceEL = null;

			I = null;
		}

		/// <summary>
		/// 短めの入力抑止フレーム数
		/// 例：ホイール操作が次のホイール入力受付に反応してしまわないように
		/// </summary>
		private const int WHEEL_INPUT_SLEEP = 5;

		/// <summary>
		/// 長めの入力抑止フレーム数
		/// 例：メニューから戻ってきたとき
		/// </summary>
		private const int LONG_INPUT_SLEEP = 30;

		/// <summary>
		/// 現在のページのテキストを表示しきってから次ページへ遷移させないための入力抑止フレーム数
		/// </summary>
		private const int NEXT_PAGE_INPUT_INTERVAL = 10;

		/// <summary>
		/// 自動モードで次ページへ遷移するまでのフレーム数
		/// </summary>
		private const int AUTO_NEXT_PAGE_INTERVAL = 180;

		private ScenarioPage CurrPage;
		private int SelectedSystemButtonIndex = -1; // -1 == システムボタン未選択

		public void Perform()
		{
			DDCurtain.SetCurtain(0, -1.0);
			DDCurtain.SetCurtain();

			bool skipMode = false;
			bool autoMode = false;

		restartCurrPage:
			this.CurrPage = this.Status.Scenario.Pages[this.Status.CurrPageIndex];

			if (!this.LoadedFlag)
				foreach (ScenarioCommand command in this.CurrPage.Commands)
					command.Invoke();

			int dispSubtitleCharCount = 0;
			int dispCharCount = 0;
			int dispPageEndedCount = 0;
			bool dispFastMode = false;

			DDEngine.FreezeInput();

			for (; ; )
			{
				DDMouse.UpdatePos();

				bool nextPageFlag = false;

				// ★★★ キー押下は 1 マウス押下は -1 で判定する。

				// 入力：シナリオを進める。(マウスホイール)
				if (DDMouse.Rot < 0)
				{
					if (dispPageEndedCount < NEXT_PAGE_INPUT_INTERVAL) // ? ページ表示_未完了 -> ページ表示_高速化
					{
						dispFastMode = true;
					}
					else // ? ページ表示_完了 -> 次ページ
					{
						if (this.Status.CurrSelect == null)
							nextPageFlag = true;
					}
					DDEngine.FreezeInput(WHEEL_INPUT_SLEEP);
				}

				// 入力：シナリオを進める。(マウスホイール_以外)
				if (
					DDMouse.L.GetInput() == -1 && this.SelectedSystemButtonIndex == -1 || // システムボタン以外を左クリック
					DDInput.A.GetInput() == 1 ||
					DDKey.GetInput(DX.KEY_INPUT_SPACE) == 1 ||
					DDKey.GetInput(DX.KEY_INPUT_RETURN) == 1
					)
				{
					if (dispPageEndedCount < NEXT_PAGE_INPUT_INTERVAL) // ? ページ表示_未完了 -> ページ表示_高速化
					{
						dispFastMode = true;
					}
					else // ? ページ表示_完了 -> 次ページ
					{
						if (this.Status.CurrSelect == null)
						{
							nextPageFlag = true;
						}
						else // 選択肢表示中
						{
							int index = this.Status.CurrSelect.GetMouseFocusedIndex();

							if (index != -1) // 選択中の選択肢へ進む
							{
								string scenarioName = this.Status.CurrSelect.Options[index].ScenarioName;

								this.Status.Scenario = new Scenario(scenarioName);
								this.Status.CurrPageIndex = 0;
								this.Status.CurrSelect = null; // 選択肢_終了
								skipMode = false;

								goto restartCurrPage;
							}
						}
					}
				}

				if (skipMode)
					if (this.Status.CurrSelect == null)
						if (1 <= dispPageEndedCount)
							nextPageFlag = true;

				if (autoMode)
					if (this.Status.CurrSelect == null)
						if (AUTO_NEXT_PAGE_INTERVAL <= dispPageEndedCount)
							nextPageFlag = true;

				if (nextPageFlag) // 次ページ
				{
					this.Status.CurrPageIndex++;

					if (this.Status.Scenario.Pages.Count <= this.Status.CurrPageIndex)
						break;

					goto restartCurrPage;
				}

				// 入力：スキップモード
				if (skipMode)
				{
					// memo:
					// システムボタンからスキップモードを開始・終了できるので競合しないようにするため、
					// キー・ボタンの開放を終了のトリガーとする。

					if (
						DDKey.GetInput(DX.KEY_INPUT_LCONTROL) == -1 ||
						DDInput.R.GetInput() == -1
						)
						skipMode = false;
				}
				else
				{
					// memo:
					// 上と同じ理由で、
					// キー・ボタンの押下を開始のトリガーとする。

					if (
						DDKey.GetInput(DX.KEY_INPUT_LCONTROL) == 1 ||
						DDInput.R.GetInput() == 1
						)
						skipMode = true;
				}

				// 入力：過去ログ
				if (
					DDKey.GetInput(DX.KEY_INPUT_LEFT) == 1 ||
					DDInput.DIR_4.GetInput() == 1 ||
					0 < DDMouse.Rot
					)
				{
					this.BackLog();
				}

				// 入力：鑑賞モード
				if (
					DDMouse.R.GetInput() == -1 ||
					DDKey.GetInput(DX.KEY_INPUT_BACK) == 1 ||
					DDInput.B.GetInput() == 1
					)
				{
					this.Appreciate();
				}


				// 入力：システムボタン
				if (DDMouse.L.GetInput() == -1 && this.SelectedSystemButtonIndex != -1) // システムボタンを左クリック
				{
					switch (this.SelectedSystemButtonIndex)
					{
						case 0: this.SaveMenu(); break;
						case 1: this.LoadMenu(); break;
						case 2: skipMode = !skipMode; break;
						case 3: autoMode = !autoMode; break;
						case 4: this.BackLog(); break;
						case 5: this.SystemMenu(); break;

						default:
							throw null; // never
					}
					if (this.SystemMenu_ReturnToTitleMenu)
						break;
				}

				// 入力：選択肢_移動
				if (this.Status.CurrSelect != null)
				{
					int moving = 0;

					if (
						DDKey.IsPound(DX.KEY_INPUT_UP) ||
						DDInput.DIR_8.IsPound()
						)
						moving = -1;

					if (
						DDKey.IsPound(DX.KEY_INPUT_DOWN) ||
						DDInput.DIR_2.IsPound()
						)
						moving = 1;

					if (moving != 0)
					{
						int optIndex = this.Status.CurrSelect.GetMouseFocusedIndex();

						if (optIndex == -1)
						{
							optIndex = 0;
						}
						else
						{
							optIndex += this.Status.CurrSelect.Options.Count + moving;
							optIndex %= this.Status.CurrSelect.Options.Count;
						}

						DDMouse.X =
							GameConsts.SELECT_FRAME_L +
							Ground.I.Picture.MessageFrame_Button2.Get_W() -
							10;
						DDMouse.Y =
							GameConsts.SELECT_FRAME_T + GameConsts.SELECT_FRAME_T_STEP * optIndex +
							Ground.I.Picture.MessageFrame_Button2.Get_H() -
							10;

						DDMouse.ApplyPos();
					}
				}

				if (
					this.CurrPage.Subtitle.Length < dispSubtitleCharCount &&
					this.CurrPage.Text.Length < dispCharCount
					)
					dispPageEndedCount++;

				if (skipMode)
				{
					dispSubtitleCharCount += 8;
					dispCharCount += 8;
				}
				else if (dispFastMode)
				{
					dispSubtitleCharCount += 2;
					dispCharCount += 2;
				}
				else
				{
					if (DDEngine.ProcFrame % 2 == 0)
						dispSubtitleCharCount++;

					if (DDEngine.ProcFrame % 3 == 0)
						dispCharCount++;
				}
				DDUtils.ToRange(ref dispSubtitleCharCount, 0, SCommon.IMAX);
				DDUtils.ToRange(ref dispCharCount, 0, SCommon.IMAX);

				// ====
				// 描画ここから
				// ====

				this.DrawSurfaces();

				this.DrawMessageWindow(); // メッセージ枠

				// システムボタン
				{
					var buttons = new[]
					{
						// p: 画像, fp: フォーカス時の画像, oh: オプショナル・ハイライト
						new { p = Ground.I.Picture.MessageFrame_Save, fp = Ground.I.Picture.MessageFrame_Save2, oh = false },
						new { p = Ground.I.Picture.MessageFrame_Load, fp = Ground.I.Picture.MessageFrame_Load2, oh = false },
						new { p = Ground.I.Picture.MessageFrame_Skip, fp = Ground.I.Picture.MessageFrame_Skip2, oh = skipMode },
						new { p = Ground.I.Picture.MessageFrame_Auto, fp = Ground.I.Picture.MessageFrame_Auto2, oh = autoMode },
						new { p = Ground.I.Picture.MessageFrame_Log, fp = Ground.I.Picture.MessageFrame_Log2, oh = false },
						new { p = Ground.I.Picture.MessageFrame_Menu, fp = Ground.I.Picture.MessageFrame_Menu2, oh = false },
					};

					int selSysBtnIdx = -1;

					for (int index = 0; index < buttons.Length; index++)
					{
						bool focused = index == this.SelectedSystemButtonIndex;

						DDDraw.SetAlpha(focused ? 1.0 : 0.8);
						DDDraw.DrawCenter(
							focused || buttons[index].oh ? buttons[index].fp : buttons[index].p,
							GameConsts.SYSTEM_BUTTON_X + index * GameConsts.SYSTEM_BUTTON_X_STEP,
							GameConsts.SYSTEM_BUTTON_Y
							);
						DDDraw.Reset();

						if (DDDraw.IsMouseCrashed())
						{
							selSysBtnIdx = index;
						}
					}
					this.SelectedSystemButtonIndex = selSysBtnIdx;
				}

				// サブタイトル文字列
				{
					int dispSubtitleLength = Math.Min(dispCharCount, this.CurrPage.Subtitle.Length);
					string dispSubtitle = this.CurrPage.Subtitle.Substring(0, dispSubtitleLength);

					DDFontUtils.DrawString(10, 413, dispSubtitle, DDFontUtils.GetFont("Kゴシック", 16));
				}

				// シナリオのテキスト文字列
				{
					int dispTextLength = Math.Min(dispCharCount, this.CurrPage.Text.Length);
					string dispText = this.CurrPage.Text.Substring(0, dispTextLength);
					string[] dispLines = dispText.Split('\n');

					for (int index = 0; index < dispLines.Length; index++)
					{
						DDFontUtils.DrawString(10, 450 + index * 30, dispLines[index], DDFontUtils.GetFont("Kゴシック", 16), false, new I3Color(110, 100, 90));
					}
				}

				if (this.Status.CurrSelect != null) // 選択肢
				{
					for (int index = 0; index < GameConsts.SELECT_FRAME_NUM; index++)
					{
						DDPicture picture = Ground.I.Picture.MessageFrame_Button;

						if (index < this.Status.CurrSelect.Options.Count)
						{
							picture = Ground.I.Picture.MessageFrame_Button2;

							if (this.Status.CurrSelect.Options[index].MouseFocused)
								picture = Ground.I.Picture.MessageFrame_Button3;
						}

						DDDraw.DrawSimple(
							picture,
							GameConsts.SELECT_FRAME_L,
							GameConsts.SELECT_FRAME_T + GameConsts.SELECT_FRAME_T_STEP * index
							);
					}
					for (int index = 0; index < this.Status.CurrSelect.Options.Count; index++)
					{
						const int title_x = 80;
						const int title_y = 28;

						DDFontUtils.DrawString(
							 GameConsts.SELECT_FRAME_L + title_x,
							 GameConsts.SELECT_FRAME_T + GameConsts.SELECT_FRAME_T_STEP * index + title_y,
							 this.Status.CurrSelect.Options[index].Title,
							 DDFontUtils.GetFont("Kゴシック", 16),
							 false,
							 new I3Color(110, 100, 90)
							 );

						// フォーカスしている選択項目を再設定
						{
							bool mouseOut = DDUtils.IsOut(
								new D2Point(
									DDMouse.X,
									DDMouse.Y
									),
								new D4Rect(
									GameConsts.SELECT_FRAME_L,
									GameConsts.SELECT_FRAME_T + GameConsts.SELECT_FRAME_T_STEP * index,
									Ground.I.Picture.MessageFrame_Button2.Get_W(),
									Ground.I.Picture.MessageFrame_Button2.Get_H()
									)
								);

							this.Status.CurrSelect.Options[index].MouseFocused = !mouseOut;
						}
					}
				}

				DDEngine.EachFrame();
			}

			DDCurtain.SetCurtain(30, -1.0);
			DDMusicUtils.Fade();

			foreach (DDScene scene in DDSceneUtils.Create(40))
			{
				this.DrawSurfaces();

				DDEngine.EachFrame();
			}

			DDEngine.FreezeInput();
		}

		/// <summary>
		/// <para>主たる画面描画</para>
		/// <para>色々な場所(モード)から呼び出されるだろう。</para>
		/// </summary>
		public void DrawSurfaces()
		{
			DDCurtain.DrawCurtain(); // 画面クリア

			Game.I.Status.Surfaces.Sort((a, b) => a.Z - b.Z); // Z-オーダー順

			foreach (Surface surface in Game.I.Status.Surfaces) // キャラクタ・オブジェクト・壁紙
				if (!surface.Act.Draw())
					surface.Draw();

			Game.I.SurfaceEL.ExecuteAllTask(); // キャラクタ・オブジェクト・壁紙 の エフェクト
		}

		/// <summary>
		/// メッセージ枠の描画
		/// </summary>
		public void DrawMessageWindow()
		{
			const int h = 136;

			DDDraw.SetAlpha(0.9);
			DDDraw.DrawRect(Ground.I.Picture.MessageFrame_Message, 0, DDConsts.Screen_H - h, DDConsts.Screen_W, h);
			DDDraw.Reset();
		}

		/// <summary>
		/// 過去ログ
		/// </summary>
		private void BackLog()
		{
			List<string> logLines = new List<string>();

			for (int index = 0; index < this.Status.CurrPageIndex; index++)
				foreach (string line in this.Status.Scenario.Pages[index].Lines)
					logLines.Add(line);

			DDEngine.FreezeInput(WHEEL_INPUT_SLEEP);

			int backIndex = 0;

			for (; ; )
			{
				if (
					DDMouse.L.GetInput() == -1 ||
					DDInput.A.GetInput() == 1 ||
					DDKey.GetInput(DX.KEY_INPUT_SPACE) == 1 ||
					DDKey.GetInput(DX.KEY_INPUT_RETURN) == 1
					)
					break;

				if (
					DDKey.IsPound(DX.KEY_INPUT_UP) ||
					DDInput.DIR_8.IsPound() ||
					0 < DDMouse.Rot
					)
					backIndex++;

				if (
					DDKey.IsPound(DX.KEY_INPUT_DOWN) ||
					DDInput.DIR_2.IsPound() ||
					DDMouse.Rot < 0
					)
					backIndex--;

				if (
					DDKey.IsPound(DX.KEY_INPUT_RIGHT) ||
					DDInput.DIR_6.GetInput() == 1
					)
					backIndex = -1;

				DDUtils.ToRange(ref backIndex, -1, logLines.Count - 1);

				if (backIndex < 0)
					break;

				this.DrawSurfaces();
				DDCurtain.DrawCurtain(-0.5);

				for (int c = 1; c <= 16; c++)
				{
					int i = logLines.Count - backIndex - c;

					if (0 <= i)
					{
						DDFontUtils.DrawString(10, DDConsts.Screen_H - c * 30 - 15, logLines[i], DDFontUtils.GetFont("Kゴシック", 16));
					}
				}
				DDEngine.EachFrame();
			}
			DDEngine.FreezeInput(WHEEL_INPUT_SLEEP);
		}

		/// <summary>
		/// 鑑賞モード
		/// </summary>
		private void Appreciate()
		{
			DDEngine.FreezeInput(WHEEL_INPUT_SLEEP);

			for (; ; )
			{
				if (
					DDMouse.L.GetInput() == -1 ||
					DDMouse.R.GetInput() == -1 ||
					DDInput.A.GetInput() == 1 ||
					DDKey.GetInput(DX.KEY_INPUT_SPACE) == 1 ||
					DDKey.GetInput(DX.KEY_INPUT_RETURN) == 1
					)
					break;

				this.DrawSurfaces();
				DDEngine.EachFrame();
			}
			DDEngine.FreezeInput(WHEEL_INPUT_SLEEP);
		}

		/// <summary>
		/// ゲーム中のセーブ画面
		/// </summary>
		private void SaveMenu()
		{
			this.SaveLoadMenu(true);
		}

		/// <summary>
		/// ゲーム中のロード画面
		/// </summary>
		private void LoadMenu()
		{
			this.SaveLoadMenu(false);
		}

		/// <summary>
		/// ゲーム中のセーブ・ロード画面
		/// </summary>
		/// <param name="saveMode">セーブモードであるか</param>
		private void SaveLoadMenu(bool saveMode)
		{
			DDSimpleMenu simpleMenu = new DDSimpleMenu()
			{
				Color = new I3Color(255, 255, 255),
				BorderColor = saveMode ? new I3Color(192, 0, 0) : new I3Color(0, 0, 192),
				WallPicture = Ground.I.Picture.星屑物語02,
				WallCurtain = -0.5,
			};

			int selectIndex = 0;

			for (; ; )
			{
				selectIndex = simpleMenu.Perform(
					saveMode ? "セーブメニュー(仮)" : "ロードメニュー(仮)",
					Ground.I.SaveDataSlots.Select(v => v == null ? "[no-data]" : SCommon.Hex.ToString(SCommon.GetSHA512(Encoding.UTF8.GetBytes(v))).Substring(0, 20)).Concat(new string[] { "戻る" }).ToArray(),
					selectIndex
					);

				if (selectIndex < GameConsts.SAVE_DATA_SLOT_NUM)
				{
					if (saveMode) // ? セーブモード
					{
						Ground.I.SaveDataSlots[selectIndex] = this.Status.Serialize();
					}
					else // ? ロードモード
					{
						if (Ground.I.SaveDataSlots[selectIndex] != null) // ロードする。
						{
							this.Status = GameStatus.Deserialize(Ground.I.SaveDataSlots[selectIndex]);
							this.CurrPage = this.Status.Scenario.Pages[this.Status.CurrPageIndex];
							break;
						}
					}
				}
				else // [戻る]
				{
					break;
				}
				//DDEngine.EachFrame(); // 不要
			}
			DDEngine.FreezeInput(LONG_INPUT_SLEEP);
		}

		private bool SystemMenu_ReturnToTitleMenu = false;

		/// <summary>
		/// システムメニュー画面
		/// </summary>
		private void SystemMenu()
		{
			this.SystemMenu_ReturnToTitleMenu = false; // reset

			DDSimpleMenu simpleMenu = new DDSimpleMenu()
			{
				Color = new I3Color(255, 255, 255),
				BorderColor = new I3Color(0, 64, 0),
				WallPicture = Ground.I.Picture.星屑物語04,
				WallCurtain = -0.5,
			};

			int selectIndex = 0;

			for (; ; )
			{
				selectIndex = simpleMenu.Perform(
					"システムメニュー(仮)",
					new string[]
					{
						"タイトルに戻る",
						"ゲームに戻る",
					},
					selectIndex
					);

				switch (selectIndex)
				{
					case 0:
						this.SystemMenu_ReturnToTitleMenu = true;
						goto endLoop;

					case 1:
						goto endLoop;

					default:
						throw null; // never
				}
				//DDEngine.EachFrame(); // 不要
			}
		endLoop:
			DDEngine.FreezeInput(LONG_INPUT_SLEEP);
		}
	}
}
